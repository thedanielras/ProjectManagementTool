@model AddProjectViewModel


<div class="modal-header">
    <h5 class="modal-title">Project Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">


    <form action="/Project/AddProject" method="post" id="add-project-form">
        <!-- Project name -->
        <div class="mt-3">
            <label asp-for="Project.Name" class="form-label"></label>
            <input asp-for="Project.Name" class="form-control">
            <span asp-validation-for="Project.Name" class="text-danger"></span>
        </div>
        <!-- Department -->
        <div class="mt-3">
            <label for="add-project-form_department" class="form-label">Department</label>
            @Html.DropDownList("add-project-form_department", Model.DepartmentSelectList, "Department", new { @class = "form-select" })           
        </div>
        <!-- Responsible user -->
        <div class="mt-3">
            <label for="add-project-form_responsible-user" class="form-label">Responsible user</label>
            @Html.DropDownList("add-project-form_responsible-user", Model.UserSelectList, "Responsible User", new { @class = "form-select" })
        </div>
        <!-- Responsible user italia -->
        <div class="mt-3">
            <label for="add-project-form_responsible-user-it" class="form-label">Responsible user italia</label>
            @Html.DropDownList("add-project-form_responsible-user-it", Model.UserSelectList, "Responsible User Italia", new { @class = "form-select" })
        </div>
        <h5 class="mt-5 text-center">Sources</h5>
        <div id="add-project-form_project-sources-container" class="mt-3"></div>
        <div class="mt-3 row">
            <div class="col text-center">
                <div>
                    <button type="button" id="add-project-form_add-project-source-btn" class="btn btn-primary text-center me-1">Add Project Source</button>
                    <button type="button" id="add-project-form_remove-project-source-btn" class="btn btn-danger text-center" disabled>Remove Project Source</button>
                </div>

            </div>
        </div>
    </form>
</div>
<div class="modal-footer">
    <button id="submit_form" type="button" class="btn btn-dark">Submit</button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
</div>
<script>

    var projectSourceTypes = @Html.Raw(Json.Serialize(@Model.ProjectSourceTypeSelectList));
    var projectSourceIndex = 0; 

    $(document).ready(function () { addProjectSourceEntryToForm(); })

    $("#submit_form").click(function () {
        debugger;
        if ($("#add-project-form").valid()) {
            serializeAddProjectForm();
        }
        $("#add-project-form").validate({
            submitHandler: function (form) {
                debugger;
                $("#add-project-form").submit();
            }
        });
    });

    $("#add-project-form").submit(function (event) {
        event.preventDefault();
        
    });

    $("#add-project-form_add-project-source-btn").click(function () {
        addProjectSourceEntryToForm();
        if (projectSourceIndex > 1) {
            $("#add-project-form_remove-project-source-btn").removeAttr('disabled');
        } else {
            $("#add-project-form_remove-project-source-btn").attr('disabled', 'disabled');
        }
    });

    $("#add-project-form_remove-project-source-btn").click(function () {
        if (projectSourceIndex < 3) { return; }
        projectSourceIndex--;
        $("#add-project-form_project-src-container-" + projectSourceIndex).remove();       
        if (projectSourceIndex < 3) { $("#add-project-form_remove-project-source-btn").attr('disabled', 'disabled'); }
    });


    function addProjectSourceEntryToForm() {
        var html = "";

        html += '<div id="add-project-form_project-src-container-' + projectSourceIndex + '" class="mb-3 mt-3">'
        html += '   <label for="add-project-form_project-src-' + projectSourceIndex + '" class="form-label">Project Source ' + projectSourceIndex+1 + '</label>'
        html += '   <div class="row">'
        html += '   <div class="col-8">'
        html += '   <input type="tel" class="form-control" id="add-project-form_project-src-' + projectSourceIndex + '" placeholder="URL" name="add-project-form_project-src-' + projectSourceIndex + '">'
        html += '   </div>'
        html += '       <div class="col-4">'
        html += '           <select id="add-project-form_project-src-type-' + projectSourceIndex + '" class="form-select">'
        html += '               <option selected>Type</option>'
        projectSourceTypes.forEach((projectSourceType) => {
            html += '           <option value="' + projectSourceType.value + '">' + projectSourceType.text + '</option>'
        });
        html += '           </select>'
        html += '       </div>'
        html += '   </div>'
        html += '</div>'

        $("#add-project-form_project-sources-container").append(html);

        projectSourceIndex++;
    }

    function serializeAddProjectForm() {     

        var formData = $("#add-project-form").serializeArray();

        for (var i = 0; i < projectSourceIndex; i++) {
            var projectSrcUrl = $("#add-project-form_project-src-" + i).val() ?? null
            if (!projectSrcUrl) { continue; }
            var projectSrcType = $("#add-project-form_project-src-type-" + i).val() ?? null          

            formData.projectSources.push({ name: "projectSources[" + i + "].sourceUrl", value: projectSrcUrl })
            formData.projectSources.push({ name: "projectSources[" + i + "].type", value: projectSrcType })
        }
        addProjectSubmitData(formData);
    }

    function addProjectSubmitData(data) {       
        $.ajax({
            type: "POST",
            url: "/projects/addProject",
            data: data,
            success: function () { alert("Project added sucessfully") }
        });
    }
</script>