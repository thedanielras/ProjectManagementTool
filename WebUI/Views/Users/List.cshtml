@{
    ViewBag.Title = "Users";
}

<div class="container">
    <h2 class="text-start">Users</h2>
    <table id="users_table" class="table table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Role</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <button id="btn-new-user" type="button" class="btn btn-primary mt-3">New User</button>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
          var usersTable = $('#users_table').DataTable(
                {
                    ajax: {
                        url: "/api/users/datatable",
                        type: "POST",
                        dataSrc: "data",
                    },
                    serverSide: true,
                    columns:
                    [
                        { data: "name" },              
                        { data: function(row) {
                            if(row.role && row.role.name)
                            {
                                return row.role.name;
                            }
                            return "user";
                        }}
                    ]
                }
            );

            $.contextMenu({
                selector: '#users_table tbody tr',
                items: {
                    details: {
                        name: "Details",
                        callback: function(key, opt) {
                            var row = opt.$trigger[0]
                            var data = usersTable.row(row).data();
                            let userId = data.userId;
                            if (userId != null && userId != "")
                            {
                                $.get("/users/detailsmodal", { userId: userId }, function (data, status, xhr) {
                                    if (data && data.payload)
                                    {
                                        $("#content_modal .modal-content").empty().html(data.payload);
                                        $("#content_modal").modal('show');
                                    }
                                });
                            }
                        }
                    },
                    edit: {
                        name: "Modify",
                        callback: function(key, opt){
                            var row = opt.$trigger[0]
                            var data = usersTable.row(row).data();
                            let userId = data.userId;
                            if (userId != null && userId != "")
                            {
                                $.get("/users/editmodal", { userId: userId }, function (data, status, xhr) {
                                    if (data && data.payload)
                                    {
                                        $("#content_modal .modal-content").empty().html(data.payload);
                                        $("#content_modal").modal('show');
                                    }
                                });
                            }
                        }
                    
                    },
                    remove: {
                        name: "Remove",
                         callback: function(key, opt){
                            var row = opt.$trigger[0]
                            var data = usersTable.row(row).data();
                            let userId = data.userId;
                            if (userId != null && userId != "")
                            {
                                $.get("/users/removemodal", { userId: userId }, function (data, status, xhr) {
                                    if (data && data.payload)
                                    {
                                        $("#content_modal .modal-content").empty().html(data.payload);
                                        $("#content_modal").modal('show');
                                    }
                                });
                            }
                        }
                    }
                }
            });

            $("#btn-new-user").click(function () {          
                $.get({
                    url: "/users/creationmodal",
                    dataType: "json",
                    success: function(data) {
                        var newFormHTML = data.payload;
                        $("#content_modal .modal-content").empty().html(newFormHTML);    
                        $("#content_modal").modal('show');
                    }
                });
            });
        });
    </script>
}